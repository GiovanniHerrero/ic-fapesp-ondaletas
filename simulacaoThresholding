import numpy as np
import matplotlib.pyplot as plt
import pywt

def hard_threshold(d, threshold):
    """Aplica a regra de Hard Thresholding."""
    return np.where(np.abs(d) > threshold, d, 0)

def soft_threshold(d, threshold):
    """Aplica a regra de Soft Thresholding."""
    return np.sign(d) * np.maximum(np.abs(d) - threshold, 0)

def main():
    # Configuração inicial
    np.random.seed(42)
    n_points = 1024
    t = np.linspace(0, 1, n_points)
    
    # Geração do sinal sintético (Senoide + Degrau + Pico)
    sinal_limpo = 1.5 * np.sin(2 * np.pi * 5 * t) 
    sinal_limpo[t > 0.5] += 2 
    sinal_limpo[(t > 0.7) & (t < 0.72)] += 3 
    
    # Adição de ruído gaussiano
    sigma = 0.25 
    ruido = np.random.normal(0, sigma, n_points)
    sinal_ruidoso = sinal_limpo + ruido
    
    # Decomposição Wavelet (db4, nível 4)
    wavelet = 'db4'
    coeffs = pywt.wavedec(sinal_ruidoso, wavelet, level=4)
    cA = coeffs[0]
    cDs = coeffs[1:]
    
    # Cálculo do Limiar Universal 
    limiar = sigma * np.sqrt(2 * np.log(n_points))
    
    # Aplicação dos limiares nos coeficientes de detalhe
    cDs_hard = [hard_threshold(c, limiar) for c in cDs]
    cDs_soft = [soft_threshold(c, limiar) for c in cDs]
    
    # Reconstrução do sinal (IDWT)
    rec_hard = pywt.waverec([cA] + cDs_hard, wavelet)
    rec_soft = pywt.waverec([cA] + cDs_soft, wavelet)
    
    # Ajuste de dimensões para plotagem
    rec_hard = rec_hard[:n_points]
    rec_soft = rec_soft[:n_points]
    
    # Visualização dos resultados
    plt.figure(figsize=(10, 8))
    
    # 1. Sinal Original vs Ruidoso
    plt.subplot(3, 1, 1)
    plt.title(rf'Sinal Ruidoso ($\sigma={sigma}$) vs Original', fontsize=12)
    plt.plot(t, sinal_ruidoso, color='silver', label='Sinal Ruidoso')
    plt.plot(t, sinal_limpo, color='black', linestyle='--', linewidth=1, label='Original')
    plt.legend(loc='upper right')
    plt.xlim(0, 1)
    
    # 2. Hard Thresholding
    plt.subplot(3, 1, 2)
    plt.title(rf'Hard Thresholding ($\lambda \approx {limiar:.2f}$)', fontsize=12)
    plt.plot(t, sinal_limpo, color='black', linestyle=':', alpha=0.3)
    plt.plot(t, rec_hard, color='red', linewidth=1.2, label='Reconstrução Hard')
    plt.legend(loc='upper right')
    plt.xlim(0, 1)
    
    # 3. Soft Thresholding
    plt.subplot(3, 1, 3)
    plt.title(rf'Soft Thresholding ($\lambda \approx {limiar:.2f}$)', fontsize=12)
    plt.plot(t, sinal_limpo, color='black', linestyle=':', alpha=0.3)
    plt.plot(t, rec_soft, color='blue', linewidth=1.2, label='Reconstrução Soft')
    plt.legend(loc='upper right')
    plt.xlim(0, 1)
    
    plt.tight_layout()
    plt.show()

if __name__ == "__main__":
    main()
